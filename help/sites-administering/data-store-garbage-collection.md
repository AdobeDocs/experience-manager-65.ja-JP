---
title: データストアのガベージコレクション
description: データストアのガベージコレクションを設定してディスク領域を解放する方法について説明します。
contentOwner: msm-service
products: SG_EXPERIENCEMANAGER/6.5/SITES
topic-tags: operations
content-type: reference
docset: aem65
exl-id: 0dc4a8ce-5b0e-4bc9-a6f5-df2a67149e22
source-git-commit: 8b4cb4065ec14e813b49fb0d577c372790c9b21a
workflow-type: tm+mt
source-wordcount: '1890'
ht-degree: 93%

---

# データストアのガベージコレクション {#data-store-garbage-collection}

従来の WCM アセットを削除すると、基になるデータストアレコードの参照がノード階層から削除されますが、データストアレコード自体は残ります。この未参照のデータストアレコードは、保持する必要のない「ガベージ」になります。複数のガベージアセットが存在する場合は、それらを削除して領域を保持し、バックアップとファイルシステムのメンテナンスパフォーマンスを最適化すると便利です。

ほとんどの場合、WCM アプリケーションは、情報は収集しても、あまり頻繁に情報を削除しません。旧バージョンより優先する新しい画像が追加されたとしても、バージョン管理システムは、いつでも旧バージョンに戻せるように旧バージョンを残します。その結果、システムに追加されるコンテンツは、そのほとんどが永続的に保存されることになります。それでは、いったい何が原因でリポジトリ内に不要な「ガベージ」が生み出されるのでしょうか。

AEMは、次の内部およびハウスキーピングアクティビティのストレージとしてリポジトリを使用します。

* ビルドおよびダウンロードされたパッケージ
* 公開レプリケーション用に作成された一時ファイル
* ワークフローのペイロード
* DAM レンダリング時に一時的に作成されたアセット

これらの一時オブジェクトがデータストア内の領域をある程度消費するほど大きく、しかもそのオブジェクトが最終的に使用されなかった場合は、そのデータストアレコード自体が「ガベージ」として残ります。標準的な WCM オーサー／パブリッシュアプリケーションの場合、このようなガベージが生まれる最大の原因は、一般的に、パブリッシュアクティベーションのプロセスにあります。データはパブリッシュにレプリケーションされる際、まず「Durbo」という名前の効率的なデータ形式でコレクションに収集されて、リポジトリ内の `/var/replication/data` に保存されます。データバンドルは通常、データストアの上限サイズを超えるので、最終的にデータストアレコードとして保存されます。レプリケーションが完了すると、`/var/replication/data` 内のノードは削除されますが、データストアレコードは「ガベージ」として残ります。

回収可能なガベージが生まれるもう 1 つの原因はパッケージです。他のデータもそうですが、パッケージデータもリポジトリ内に保存され、4 KB を超えるパッケージはデータストア内に保存されます。開発プロジェクトの工程やその後のシステムのメンテナンスでは、パッケージのビルドとリビルドが何度も行われ、ビルドが行われるたびに新しいデータストアレコードができて、以前のビルドのレコードは孤立します。

## データストアのガベージコレクションの機能 {#how-does-data-store-garbage-collection-work}

リポジトリが外部データストアに設定されている場合、週別メンテナンスウィンドウの一部として、[データストアのガベージコレクションは自動的に実行](/help/sites-administering/data-store-garbage-collection.md#automating-data-store-garbage-collection)されます。また、システム管理者は必要に応じて、[データストアのガベージコレクションを手動で実行](#running-data-store-garbage-collection)することもできます。一般的に、データストアのガベージコレクションは定期的に実行することが推奨されますが、データストアのガベージコレクションを計画するときは、次の事項を考慮する必要があります。

* データストアのガベージコレクションは時間がかかり、パフォーマンスに影響する可能性があるので、適切に計画する必要があります。
* データストアのガベージレコードを削除しても通常のパフォーマンスに影響はないので、これはパフォーマンス最適化ではありません。
* ストレージの使用状況や、バックアップ時間などの関連要素に問題がない場合は、データストアのガベージコレクションを延期しても安全です。

データストアのガベージコレクターは最初に、プロセスを開始する際に現在のタイムスタンプを記録します。その後、マルチパスマーク／消去パターンアルゴリズムを使用してガベージコレクションが実行されます。

第 1 段階では、データストアのガベージコレクターが、すべてのリポジトリコンテンツを包括的にトラバーサルします。 データストアレコードを参照する各コンテンツオブジェクトについて、データストアのガベージコレクターは、ファイルシステムからファイルを見つけてメタデータの更新を実行し、「最終変更日」または MTIME 属性を変更します。この時点で、この段階までにアクセスされたファイルは、当初のベースラインタイムスタンプより新しいものになります。

第 2 段階では、データストアのガベージコレクターは、「検索」とほとんど同じ方法で、データストアの物理的なディレクトリ構造を調べます。ファイルの「最終変更日」または MTIME 属性を調べて、次の判断を行います。

* MTIME が当初のベースラインタイムスタンプより新しい場合、そのファイルは、第 1 段階で見つけたファイルか、ガベージコレクション処理中にリポジトリに追加されたまったく新しいファイルであるかのどちらかです。どちらの場合も、レコードはアクティブ状態になるので、ファイルは削除されません。
* MTIME が当初のベースラインタイムスタンプより古い場合、そのファイルはアクティブに参照されていないので、削除可能なガベージと見なされます。

この方法は、プライベートなデータストアを持つ単一のノードに適しています。ただし、データストアは共有されている場合があります。その場合、他のリポジトリからデータストアレコードへのアクティブなライブ参照はチェックされず、そのアクティブな参照ファイルが誤って削除される可能性があります。システム管理者はガベージコレクションを計画する前に、データストアが共有されていないかどうかを確認し、データストアが共有されていないことが明確な場合にのみ、シンプルな組み込みデータストアのガベージコレクションプロセスを使用するようにしてください。

>[!NOTE]
>
>クラスター化または共有データストアでガベージコレクションを実行する際に、（Mongo または Segment Tar を使用して）設定すると、特定の Blob ID を削除できないことに関する警告がログに表示される場合があります。これは、以前のガベージコレクションで削除された Blob ID が、その ID が削除されたことを知らない他のクラスターまたは共有ノードによって誤って再度参照されることが原因で発生します。その結果、前回の実行時に既に削除された ID を、ガベージコレクションで再度削除しようとするので、警告がログに記録されます。この動作は、パフォーマンスや機能に影響しません。

## データストアのガベージコレクションの実行 {#running-data-store-garbage-collection}

データストアのガベージコレクションは、AEM が実行されているデータストアの設定に応じて、3 つの方法で実行できます。

1. [リビジョンクリーンアップ](/help/sites-deploying/revision-cleanup.md)経由 - ノードストアのクリーンアップに一般的に使用されるガベージコレクションメカニズム。

1. [データストアのガベージコレクション](/help/sites-administering/data-store-garbage-collection.md#running-data-store-garbage-collection-via-the-operations-dashboard)（外部データストア用のガベージコレクションメカニズムで、操作ダッシュボードで使用可能）を介して。
1. [JMX コンソール](/help/sites-administering/jmx-console.md)を介して。

TarMK がノードストアとデータストアの両方として使用されている場合は、その両方のガベージコレクションにリビジョンクリーンアップを使用できます。一方、ファイルシステムデータストアなど外部データストアが設定されている場合は、リビジョンクリーンアップとは別に、データストアのガベージコレクションを明示的にトリガーする必要があります。データストアのガベージコレクションは、操作ダッシュボードまたは JMX コンソールを通じてトリガーできます。

次の表に、AEM 6 でサポートされているすべてのデータストアのデプロイメントで使用する必要がある、データストアのガベージコレクションの種類を示します。

<table>
 <tbody>
  <tr>
   <td><strong>ノードストア</strong><br /> </td>
   <td><strong>データストア</strong></td>
   <td><strong>ガベージコレクションのメカニズム</strong><br /> </td>
  </tr>
  <tr>
   <td>TarMK</td>
   <td>TarMK</td>
   <td>リビジョンクリーンアップ（バイナリはセグメントストアとインライン化されています）</td>
  </tr>
  <tr>
   <td>TarMK</td>
   <td>外部ファイルシステム</td>
   <td><p>操作ダッシュボードを使用したデータストアのガベージコレクションタスク</p> <p>JMX コンソール</p> </td>
  </tr>
  <tr>
   <td>MongoDB</td>
   <td>MongoDB</td>
   <td><p>操作ダッシュボードを使用したデータストアのガベージコレクションタスク</p> <p>JMX コンソール</p> </td>
  </tr>
  <tr>
   <td>MongoDB</td>
   <td>外部ファイルシステム</td>
   <td><p>操作ダッシュボードを使用したデータストアのガベージコレクションタスク</p> <p>JMX コンソール</p> </td>
  </tr>
 </tbody>
</table>

### 操作ダッシュボードによるデータストアのガベージコレクションの実行 {#running-data-store-garbage-collection-via-the-operations-dashboard}

[操作ダッシュボード](/help/sites-administering/operations-dashboard.md)から使用できる組み込みの週別メンテナンスウィンドウには、データストアのガベージコレクションを毎週日曜日午前 1 時に起動するタスクが組み込まれています。

データストアのガベージコレクションをこの時間帯以外に実行する必要がある場合は、操作ダッシュボードから手動でトリガーできます。

データストアのガベージコレクションを実行する前に、その時間にバックアップが実行されていないことを確認してください。

1. 次の方法で操作ダッシュボードを開きます。 **ナビゲーション** > **ツール** > **運用** > **メンテナンス**.
1. 次をクリック： **週別メンテナンスウィンドウ**.

   ![chlimage_1-64](assets/chlimage_1-64.png)

1. を選択します。 **データストアのガベージコレクション** タスクを実行し、 **実行** アイコン。

   ![chlimage_1-65](assets/chlimage_1-65.png)

1. データストアのガベージコレクションが実行され、そのステータスがダッシュボードに表示されます。

   ![chlimage_1-66](assets/chlimage_1-66.png)

>[!NOTE]
>
>「データストアのガベージコレクション」タスクは、外部ファイルデータストアが設定されている場合にのみ表示されます。ファイルデータストアのセットアップ方法については、[AEM 6 でのノードストアとデータストアの設定](/help/sites-deploying/data-store-config.md#file-data-store)を参照してください。

### JMX コンソールによるデータストアのガベージコレクションの実行 {#running-data-store-garbage-collection-via-the-jmx-console}

この節では、JMX コンソールを使用してデータストアのガベージコレクションを手動で実行する方法を説明します。外部データストアなしでインストールをセットアップしている場合は、この節で説明する内容は適用されません。その場合は、[リポジトリのメンテナンス](/help/sites-deploying/storage-elements-in-aem-6.md#maintaining-the-repository)で説明するリビジョンクリーンアップの実行方法を参照してください。

>[!NOTE]
>
>TarMK を外部データストアで実行している場合、ガベージコレクションを有効にするには、最初にリビジョンクリーンアップを実行する必要があります。

ガベージコレクションを実行するには：

1. Apache Felix OSGi 管理コンソールで、「**メイン**」タブをアクティブにし、次のメニューから「**JMX**」を選択します。
1. 次に、「**リポジトリマネージャー** MBean」を検索して、クリックします（または`https://<host>:<port>/system/console/jmx/org.apache.jackrabbit.oak%3Aname%3Drepository+manager%2Ctype%3DRepositoryManagement`に移動します）。
1. 「**startDataStoreGC(boolean markOnly)**」をクリックします。
1. &quot;と入力します。`true`」 `markOnly` 必要に応じて、パラメーターを指定します。

   | **オプション** | **説明** |
   |---|---|
   | boolean markOnly | 参照のマークのみを行い、マークスイープ操作でスイープを行わない場合は true に設定します。このモードは、元になる BlobStore が異なる複数のリポジトリで共有されているときに使用されます。それ以外の場合はすべて false に設定してフルガベージコレクションを実行します。 |

1. クリック **起動**. CRX はガベージコレクションを実行し、完了した時点を示します。

>[!NOTE]
>
>データストアのガベージコレクションでは、過去 24 時間以内に削除されたファイルは収集しません。

>[!NOTE]
>
>データストアのガベージコレクションタスクは、外部ファイルデータストアが設定されている場合にのみ開始されます。外部ファイルデータストアが設定されていない場合は、このタスクは呼び出し後に `Cannot perform operation: no service of type BlobGCMBean found` というメッセージを返します。ファイルデータストアのセットアップ方法については、[AEM 6 でのノードストアとデータストアの設定](/help/sites-deploying/data-store-config.md#file-data-store)を参照してください。

## データストアのガベージコレクションの自動化 {#automating-data-store-garbage-collection}

可能な場合は、データストアのガベージコレクションは、システムに負荷が少ない場合（例：午前中）に実行する必要があります。

[操作ダッシュボード](/help/sites-administering/operations-dashboard.md)から使用できる組み込みの週別メンテナンスウィンドウには、データストアのガベージコレクションを毎週日曜日午前 1 時に起動するタスクが組み込まれています。また、その時間にバックアップが実行されていないことを確認する必要もあります。メンテナンスウィンドウの開始時間は、必要に応じてダッシュボードでカスタマイズできます。

>[!NOTE]
>
>同時に実行しない理由は、古い（および未使用の）データストアファイルもバックアップされるようにするためです。古いバージョンにロールバックする必要がある場合に備えて、バイナリがバックアップに残してあります。

データストアのガベージコレクションを、操作ダッシュボードの週別メンテナンスウィンドウと共に実行しない場合は、wget または curl HTTP クライアントを使用してガベージコレクションを自動化することもできます。以下に、curl を使用してバックアップを自動化する方法の例を示します。

>[!CAUTION]
>
>以下の `curl` コマンドでは、インスタンスに対して様々なパラメーターを設定する必要がある場合があります。例えば、ホスト名（`localhost`）、ポート（`4502`）、管理パスワード（`xyz`）および実際のデータストアのガベージコレクションのための各種パラメーターです。

次に、データストアのガベージコレクションをコマンドラインから起動する curl コマンドの例を示します。

```shell
curl -u admin:admin -X POST --data markOnly=true  https://localhost:4503/system/console/jmx/org.apache.jackrabbit.oak"%"3Aname"%"3Drepository+manager"%"2Ctype"%"3DRepositoryManagement/op/startDataStoreGC/boolean
```

curl コマンドはすぐに制御を返します。

## データストアの整合性チェック {#checking-data-store-consistency}

データストアの整合性チェックは、欠落しているもののまだ参照されているデータストアのバイナリを報告するものです。整合性チェックを開始するには、次の手順を実行します。

1. JMX コンソールに移動します。JMX コンソールの使い方について詳しくは、[この記事](/help/sites-administering/jmx-console.md#using-the-jmx-console)を参照してください。
1. **BlobGarbageCollection** Mbean を検索し、それをクリックします。
1. 「`checkConsistency()`」リンクをクリックします。

整合性チェックが完了すると、メッセージに欠落として報告されるバイナリの数が表示されます。この数が 0 を超えている場合は、`error.log` で欠落しているバイナリの詳細を確認できます。

欠落しているバイナリがログにどのように表示されるかを次に示します。

```xml
11:32:39.673 INFO [main] MarkSweepGarbageCollector.java:600 Consistency check found [1] missing blobs
```

```xml
11:32:39.673 WARN [main] MarkSweepGarbageCollector.java:602 Consistency check failure intheblob store : DataStore backed BlobStore [org.apache.jackrabbit.oak.plugins.blob.datastore.OakFileDataStore], check missing candidates in file /tmp/gcworkdir-1467352959243/gccand-1467352959243
```
